generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pgvector(map: "vector")]
}

model User {
  id           String       @id @default(uuid())
  email        String       @unique
  passwordHash String       @map("password_hash")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  profile               UserProfile?
  shifts                Shift[]
  incidents             Incident[]
  weeklyExports         WeeklyExport[]
  providerCertifications ProviderCertification[]
  reminderRules         ReminderRule[]

  @@map("users")
}

model UserProfile {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  name      String
  timezone  String   @default("America/Los_Angeles")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model Shift {
  id              String          @id @default(uuid())
  userId          String          @map("user_id")
  recipientName   String?         @map("recipient_name")
  status          ShiftStatus     @default(active)
  startedAt       DateTime        @default(now()) @map("started_at")
  endedAt         DateTime?       @map("ended_at")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  events          ShiftEvent[]
  structuredNotes StructuredNote[]

  @@index([userId])
  @@map("shifts")
}

enum ShiftStatus {
  active
  completed
}

model ShiftEvent {
  id          String   @id @default(uuid())
  shiftId     String   @map("shift_id")
  userId      String   @map("user_id")
  type        String
  description String
  occurredAt  DateTime @default(now()) @map("occurred_at")
  createdAt   DateTime @default(now()) @map("created_at")
  shift       Shift    @relation(fields: [shiftId], references: [id], onDelete: Cascade)

  @@index([shiftId])
  @@map("shift_events")
}

model StructuredNote {
  id            String   @id @default(uuid())
  shiftId       String   @map("shift_id")
  userId        String   @map("user_id")
  version       Int      @default(1)
  isFinal       Boolean  @default(false) @map("is_final")
  content       Json
  modelUsed     String   @map("model_used")
  promptVersion String   @map("prompt_version")
  createdAt     DateTime @default(now()) @map("created_at")
  shift         Shift    @relation(fields: [shiftId], references: [id], onDelete: Cascade)

  @@map("structured_notes")
}

model WeeklyExport {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  weekStart DateTime @map("week_start")
  weekEnd   DateTime @map("week_end")
  content   Json
  pdfPath   String?  @map("pdf_path")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("weekly_exports")
}

model Incident {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  description    String
  structuredJson Json?    @map("structured_json")
  modelUsed      String?  @map("model_used")
  promptVersion  String?  @map("prompt_version")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("incidents")
}

model CertificationType {
  id                   String                  @id @default(uuid())
  name                 String
  description          String?
  defaultValidityDays  Int?                    @map("default_validity_days")
  isCommon             Boolean                 @default(false) @map("is_common")
  createdAt            DateTime                @default(now()) @map("created_at")
  certifications       ProviderCertification[]
  reminderRules        ReminderRule[]

  @@map("certification_types")
}

enum CertificationStatus {
  active
  expired
  expiring_soon
  missing
}

enum ReminderChannel {
  email
}

enum ReminderEventStatus {
  scheduled
  sent
  failed
}

model ProviderCertification {
  id                  String              @id @default(uuid())
  providerId          String              @map("provider_id")
  certificationTypeId String?             @map("certification_type_id")
  customName          String?             @map("custom_name")
  issuedDate          DateTime?           @map("issued_date")
  expirationDate      DateTime?           @map("expiration_date")
  status              CertificationStatus @default(active)
  documentUrl         String?             @map("document_url")
  notes               String?
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")
  provider            User                @relation(fields: [providerId], references: [id], onDelete: Cascade)
  certificationType   CertificationType?  @relation(fields: [certificationTypeId], references: [id], onDelete: SetNull)
  reminderEvents      ReminderEvent[]

  @@index([providerId])
  @@index([status])
  @@map("provider_certifications")
}

model ReminderRule {
  id                  String             @id @default(uuid())
  providerId          String             @map("provider_id")
  certificationTypeId String?            @map("certification_type_id")
  daysBeforeExpiration Int               @map("days_before_expiration")
  enabled             Boolean            @default(true)
  createdAt           DateTime           @default(now()) @map("created_at")
  updatedAt           DateTime           @updatedAt @map("updated_at")
  provider            User               @relation(fields: [providerId], references: [id], onDelete: Cascade)
  certificationType   CertificationType? @relation(fields: [certificationTypeId], references: [id], onDelete: SetNull)

  @@index([providerId])
  @@map("reminder_rules")
}

model ReminderEvent {
  id                      String               @id @default(uuid())
  providerCertificationId String               @map("provider_certification_id")
  scheduledFor            DateTime             @map("scheduled_for")
  sentAt                  DateTime?            @map("sent_at")
  channel                 ReminderChannel      @default(email)
  status                  ReminderEventStatus  @default(scheduled)
  errorMessage            String?              @map("error_message")
  createdAt               DateTime             @default(now()) @map("created_at")
  certification           ProviderCertification @relation(fields: [providerCertificationId], references: [id], onDelete: Cascade)

  @@index([scheduledFor])
  @@index([status])
  @@map("reminder_events")
}

model KnowledgeDocument {
  id            String           @id @default(uuid())
  title         String
  source        String
  jurisdiction  String?
  effectiveDate DateTime?        @map("effective_date")
  createdAt     DateTime         @default(now()) @map("created_at")
  chunks        KnowledgeChunk[]

  @@map("knowledge_documents")
}

model KnowledgeChunk {
  id           String            @id @default(uuid())
  documentId   String            @map("document_id")
  title        String
  source       String
  content      String
  chunkIndex   Int               @map("chunk_index")
  /// @zod.custom(z.string()) stored as vector string
  embedding    Unsupported("vector(1536)")?
  createdAt    DateTime          @default(now()) @map("created_at")
  document     KnowledgeDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@map("knowledge_chunks")
}
